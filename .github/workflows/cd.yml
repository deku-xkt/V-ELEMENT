name: CD

on:
  workflow_run:
    workflows: ['CI']
    types:
      - completed

permissions:
  contents: read
  actions: read

jobs:
  prepare-release:
    name: Prepare Release Assets
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Download library artifact from CI run
        uses: actions/download-artifact@v4
        with:
          name: library-dist
          path: release-assets/library-dist
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download docs artifact from CI run
        uses: actions/download-artifact@v4
        with:
          name: docs-dist
          path: release-assets/docs-dist
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show downloaded files
        run: |
          echo "Library artifact:"
          ls -la release-assets/library-dist | head -n 20
          echo "Docs artifact:"
          ls -la release-assets/docs-dist | head -n 20

      - name: Upload release bundle
        uses: actions/upload-artifact@v4
        with:
          name: release-bundle
          path: release-assets
          retention-days: 7
